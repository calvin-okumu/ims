# Banking Access Control System with ZKTECO Integration

## Overview

This is a Next.js-based Banking Access Control System that integrates with the ZKTECO BioCVSecurity API to manage private banking customers and their spouses' access to specific areas. The system uses PIN-based account numbers as unique identifiers, with automatic spouse account generation and access level management.

## Features

- **PIN-Based Registration**: Account numbers serve as unique PINs for ZK API integration
- **Couple Registration**: Principal and spouse registration with automatic relationship tracking
- **Biometric Integration**: Optional fingerprint template upload and retrieval via ZK API (can be added during editing)
- **Access Level Management**: Automatic assignment and cascade removal for linked accounts
- **Branch Management**: Hierarchical department/branch structure with creation capabilities
- **Real-time API Integration**: Direct integration with ZKTECO BioCVSecurity API endpoints
- **Responsive UI**: Modern dark theme interface built with Tailwind CSS and TypeScript

## Tech Stack

- **Frontend**: Next.js 16, React 19, TypeScript
- **Backend**: SQLite (better-sqlite3) for data persistence
- **API Proxy**: Next.js API routes for CORS/SSL handling
- **Styling**: Tailwind CSS
- **HTTP Client**: Axios with custom HTTPS agent
- **API**: ZKTECO BioCVSecurity API v2.0 (via proxy)
- **Authentication**: Access token via URL parameters
- **Data Sync**: Automatic refresh with manual controls

## Setup

### Prerequisites

1. **ZKBio CVSecurity Server**: Ensure your ZKBio CVSecurity server is running and accessible
2. **API Authorization Setup**: Configure API access in ZKBio admin panel (see below)
3. **Network Access**: Ensure the application server can reach the ZKBio server

### ZKBio API Authorization Setup

Follow these steps to configure API authorization in your ZKBio CVSecurity admin panel:

#### Step 1: Access ZKBio Admin Panel

1. Open your web browser and navigate to your ZKBio CVSecurity server:
   ```
   https://192.168.183.114:8098
   ```

2. Log in with superuser credentials:
   - **Username**: `admin` (or your superuser account)
   - **Password**: `#eCOM@786SEC` (or your configured password)

#### Step 2: Navigate to API Authorization

1. In the admin panel, go to:
   ```
   System â†’ Authority Management â†’ API Authorization
   ```

2. You should see the API Authorization management page.

#### Step 3: Create New API Client

1. Click the **New** button at the upper part of the list.

2. Configure the API client:
   - **Client ID**: Enter a unique identifier (e.g., `banking-system-api`)
   - **Client Secret**: This will be auto-generated by the system

3. **Important**: Save the generated **Client Secret** - this is your API token!

#### Step 4: Enable API Access

1. After creating the client, click **Browse API** on the API Authorization page.

2. This opens the API operation page - keep this page open for normal API access.

3. **Note**: If client ID and secret are not properly configured, API access will be abnormal.

### Application Setup

1. Clone the repository.
2. Install dependencies: `npm install`
3. Create `.env.local` with your ZKBio API credentials:
   ```
   NEXT_PUBLIC_ZKBIO_API_URL=https://192.168.183.114:8098/api
   NEXT_PUBLIC_ZKBIO_API_TOKEN=8D1E99707293387C5B3BFC7291AD38CB
   ```
4. Run the development server: `npm run dev`
5. Open http://localhost:3000

### API Proxy Configuration

The application uses Next.js API proxy routes to handle CORS and SSL certificate issues:

#### Core ZKTECO API Endpoints (v2 where available)
- **Person Management**: `/api/persons` â†’ ZKBio `v2/person/getPersonList`, `v2/person/add`
- **Access Levels**: `/api/access-levels` â†’ ZKBio `v2/accLevel/list`
- **Biometric Templates**: `/api/biometric` â†’ ZKBio `bioTemplate/add` (v1), `v2/bioTemplate/getFgListByPin` (v2)
- **Access Assignment**: `/api/access-levels/assign` â†’ ZKBio `accLevel/addLevelPerson`
- **Branch Management**: `/api/branches` â†’ ZKBio `department/getDepartmentList`, `department/add` (v1)

The proxy automatically:
- Bypasses CORS restrictions
- Handles self-signed SSL certificates
- Formats ZKBio API responses
- Provides error handling and logging

## Usage

### Registration System

#### Single User Registration
- Enter unique PIN (max 15 characters) as account identifier
- Provide personal details (name, email, phone, gender)
- Select branch/department from hierarchical dropdown
- Optional: Card number and fingerprint template
- Choose access level for automatic assignment

#### Couple Registration
- Register principal with full details
- Spouse automatically gets PIN with "s1" suffix (e.g., PB-123456 â†’ PB-123456s1)
- Both principal and spouse get same branch and access level
- Separate biometric data for each person
- Automatic relationship tracking for access management

### Data Management
- **Real-time Sync**: Automatic data refresh every 5 minutes
- **Manual Refresh**: Global refresh controls for immediate updates
- **Branch Hierarchy**: Create and manage organizational structure
- **Access Control**: Automatic assignment and cascade removal

## API Endpoints

### ZKTECO API Proxy Routes

#### Person Management
- `GET /api/persons` - Fetch personnel list with filtering
- `PUT /api/persons` - Create new person with PIN, branch, and access level
- `POST /api/persons` - Legacy person list retrieval

#### Biometric Templates
- `PUT /api/biometric` - Upload fingerprint template to ZK API
- `GET /api/biometric?pin={pin}` - Retrieve biometric templates for PIN

#### Access Level Management
- `GET /api/access-levels` - Fetch available access levels
- `POST /api/access-levels/assign` - Assign access level to person
- `DELETE /api/access-levels/assign` - Remove access level from person

#### Branch/Department Management
- `GET /api/branches` - Fetch hierarchical branch structure
- `POST /api/branches` - Create new branch/department

### Legacy SQLite Endpoints
- `GET /api/accounts` - Retrieve all accounts
- `POST /api/accounts` - Create a new account
- `GET /api/accounts/{id}` - Retrieve specific account
- `PUT /api/accounts/{id}` - Update account status/details
- `DELETE /api/accounts/{id}` - Delete account

## Current Application Status

### âœ… Fully Operational Features

#### Advanced Registration System
- **PIN-Based Registration**: Account numbers serve as ZK API PINs (max 15 characters)
- **Couple Registration**: Principal + spouse with automatic "s1" suffix generation
- **Biometric Integration**: Optional fingerprint upload via ZK API (can be added during editing)
- **Access Level Assignment**: Automatic assignment during registration
- **Branch Management**: Hierarchical department structure with creation
- **Relationship Tracking**: Principal-spouse linkage via PIN for access management

#### API Integration Status
- **Person Registration**: âœ… Full CRUD with PIN, branch, and access level
- **Biometric Templates**: âœ… Upload and retrieval via ZK API
- **Access Assignment**: âœ… Real-time assignment and cascade removal
- **Branch Hierarchy**: âœ… Full CRUD with parent-child relationships
- **Person Data**: âœ… 5 users successfully loaded and displayed
- **Access Levels**: âœ… 1 access level loaded with assignment capabilities

#### UI/UX Enhancements
- **Skeleton Loading**: Professional loading states during data fetch
- **Enhanced Notifications**: Progress bars and multiple notification types
- **Form Validation**: Real-time validation with custom rules
- **Error Boundaries**: Graceful error handling for API failures
- **Responsive Design**: Mobile-friendly interface

### ðŸ“Š Data Structure

#### PIN-Based Account System
- **Principal PIN**: Account number (max 15 characters)
- **Spouse PIN**: Principal PIN + "s1" suffix
- **Relationship Tracking**: Automatic spouse linkage via PIN
- **Access Inheritance**: Spouses inherit principal's access levels

#### Access Levels (1 total)
```json
[{"id": "402880f39ae893ad019ae895fe3d0463", "name": "General"}]
```



### ZKTECO Integration

#### Active API Endpoints (v2 where available)
- **Person Management**: `v2/person/add`, `v2/person/getPersonList`
- **Biometric Templates**: `bioTemplate/add` (v1), `v2/bioTemplate/getFgListByPin` (v2)
- **Access Levels**: `v2/accLevel/list`, `accLevel/addLevelPerson`
- **Branch Management**: `department/add`, `department/getDepartmentList` (v1)

#### Documentation
- **API Setup Guide**: `docs/zkbio-api-setup-guide.md` - Complete setup instructions for ZKBio API authorization
- **API Reference**: `docs/zkteco-api-reference-latest.md` - Full API documentation with working endpoints
- **API Summary**: `docs/zkteco-api-summary.md` - Overview of ZKTECO BioCVSecurity API integration status

## Development

- Lint: `npm run lint`
- Build: `npm run build`
- Start production: `npm start`

## Notes

### Registration System
- **PIN Requirements**: Account numbers serve as ZK API PINs (max 15 characters, no format restrictions)
- **Spouse Relationship**: Automatic "s1" suffix generation for spouse accounts
- **Access Management**: Principal access removal cascades to linked spouse accounts
- **Branch Assignment**: Same department/branch for principal and spouse

### Biometric Integration
- **Real-time Upload**: Fingerprint templates uploaded directly to ZK API during registration
- **Template Format**: Base64 encoded biometric data with version and validation info
- **Retrieval**: Biometric templates can be fetched for verification and management

### API Integration
- **Proxy Routes**: All ZK API calls routed through Next.js for CORS and SSL handling
- **Error Handling**: Comprehensive error handling with user-friendly messages
- **Data Validation**: Client and server-side validation for all API operations

### Security Considerations
- **PIN Security**: Handle PIN codes securely, never log in plain text
- **Biometric Data**: Store and transmit biometric templates with appropriate security
- **Access Control**: Implement proper authorization for all API operations