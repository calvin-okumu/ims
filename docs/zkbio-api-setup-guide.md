# ZKBio CVSecurity API Setup Guide

## Overview

This guide provides detailed instructions for setting up and configuring the ZKBio CVSecurity API integration for your Banking Access Control System. The application uses Next.js API proxy routes to handle CORS and SSL certificate issues automatically.

## Prerequisites

- ZKBio CVSecurity server (version 6.0.0 or above) running and accessible
- Superuser access to ZKBio admin panel
- Network access to ZKBio server from your application server
- Next.js application with API proxy routes configured

## API Authorization Setup

### Step 1: Access ZKBio Admin Panel

1. Open your web browser and navigate to your ZKBio CVSecurity server

2. Log in with superuser credentials:
   - **Username**: `admin` (or your superuser account)
   - **Password**: `#eCOM@786SEC` (or your configured password)

### Step 2: Navigate to API Authorization

1. In the admin panel, go to:
   ```
   System â†’ Authority Management â†’ API Authorization
   ```

2. You should see the API Authorization management page.

### Step 3: Create New API Client

1. Click the **New** button at the upper part of the list.

2. Configure the API client:
   - **Client ID**: Enter a unique identifier (e.g., `banking-system-api`)
   - **Client Secret**: This will be auto-generated by the system

3. **Important**: Save the generated **Client Secret** - this is your API token!

### Step 4: Enable API Access

1. After creating the client, click **Browse API** on the API Authorization page.

2. This opens the API operation page - keep this page open for normal API access.

3. **Note**: If client ID and secret are not properly configured, API access will be abnormal.

### Step 5: Configure Application Environment

Create or update your `.env.local` file with the API credentials:

```bash
NEXT_PUBLIC_ZKBIO_API_URL=https://192.168.183.114:8098/api
NEXT_PUBLIC_ZKBIO_API_TOKEN=8D1E99707293387C5B3BFC7291AD38CB
```

The Client Secret `8D1E99707293387C5B3BFC7291AD38CB` is already configured and working.

## API Proxy Implementation

The application uses Next.js API proxy routes to handle CORS and SSL certificate issues automatically. This means:

### âœ… Automatic Handling
- **CORS Bypass**: Server-side requests avoid browser CORS restrictions
- **SSL Certificate**: Self-signed certificates are handled automatically
- **Error Handling**: Comprehensive error handling and logging
- **Response Formatting**: ZKBio API responses are properly formatted

### ðŸ“¡ Proxy Endpoints

| Frontend Route | ZKBio API Endpoint | Status |
|----------------|-------------------|---------|
| `POST /api/persons` | `POST /api/v2/person/getPersonList` | âœ… Working |
| `GET /api/access-levels` | `GET /api/v2/accLevel/list` | âœ… Working |

### ðŸ”„ Data Synchronization

The application automatically:
- **Loads data on page refresh** from ZKBio API
- **Refreshes every 5 minutes** in the background
- **Provides manual refresh** buttons
- **Shows last updated timestamps**
- **Handles loading states** with skeleton screens

## API Authentication Method

### URL Parameter Authentication

ZKBio CVSecurity requires access tokens to be passed as URL parameters, not in headers:

```bash
# Direct API call format
GET /api/v2/endpoint?access_token=YOUR_CLIENT_SECRET

# Incorrect format (will not work)
GET /api/v2/endpoint
Authorization: Bearer YOUR_CLIENT_SECRET
```

### Example API Calls (Direct)

```bash
# Get access levels
curl -k "https://192.168.183.114:8098/api/v2/accLevel/list?pageNo=1&pageSize=5&access_token=8D1E99707293387C5B3BFC7291AD38CB"

# Get persons
curl -k -X POST "https://192.168.183.114:8098/api/v2/person/getPersonList?pageNo=1&pageSize=5&access_token=8D1E99707293387C5B3BFC7291AD38CB"

# Get readers
curl -k "https://192.168.183.114:8098/api/v2/reader/list?pageNo=1&pageSize=5&access_token=8D1E99707293387C5B3BFC7291AD38CB"
```

### Current Data Status

#### âœ… Person Data (5 records loaded)
```json
[
  {
    "pin": "23510009090",
    "name": "George",
    "lastName": "Mrema",
    "deptName": "PRIVATE BANKING CUSTOMER",
    "gender": "M",
    "email": "calvin@comsec.co.tz"
  },
  {
    "pin": "23510009090S1",
    "name": "Zainab",
    "lastName": "Gamaru",
    "deptName": "SPOUSE PRIVATE BANKING",
    "accLevelIds": "402880f39ae893ad019ae895fe3d0463"
  }
  // ... 3 more records
]
```

#### âœ… Access Level Data (1 record loaded)
```json
[
  {
    "id": "402880f39ae893ad019ae895fe3d0463",
    "name": "General"
  }
]
```

### Example API Calls

```bash
# Get access levels
curl -k "https://192.168.183.114:8098/api/v2/accLevel/list?pageNo=1&pageSize=10&access_token=8D1E99707293387C5B3BFC7291AD38CB"

# Get persons
curl -k "https://192.168.183.114:8098/api/v2/person/getPersonList?pageNo=1&pageSize=10&access_token=8D1E99707293387C5B3BFC7291AD38CB"

# Get departments
curl -k "https://192.168.183.114:8098/api/department/getDepartmentList?pageNo=1&pageSize=10&access_token=8D1E99707293387C5B3BFC7291AD38CB"
```

## API Response Format

All ZKBio API responses follow this structure:

```json
{
  "code": 0,
  "message": "success",
  "data": {
    // Actual response data
  }
}
```

### Response Codes

- `code: 0` = Success
- `code: 400` = Bad Request
- `code: 401` = Unauthorized (check access token)
- `code: 403` = Forbidden
- `code: 404` = Not Found

## Testing API Connection

### 1. Test Access Levels API

```bash
curl -k "https://your-server:8098/api/v2/accLevel/list?pageNo=1&pageSize=5&access_token=YOUR_TOKEN" | jq .
```

Expected response:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "page": 0,
    "size": 5,
    "total": 1,
    "data": [
      {
        "id": "access_level_id",
        "name": "General"
      }
    ],
    "offset": 0,
    "lastPage": true
  }
}
```

### 2. Test Person API

```bash
curl -k "https://your-server:8098/api/v2/person/getPersonList?pageNo=1&pageSize=5&access_token=YOUR_TOKEN" | jq .
```

### 3. Test Reader API

```bash
curl -k "https://your-server:8098/api/v2/reader/list?pageNo=1&pageSize=5&access_token=YOUR_TOKEN" | jq .
```

## Troubleshooting

### Current Status: âœ… FULLY OPERATIONAL

The API integration is **working perfectly** with the following configuration:

- **Server**: `https://192.168.183.114:8098`
- **Token**: `8D1E99707293387C5B3BFC7291AD38CB`
- **Proxy Routes**: Active and handling CORS/SSL issues
- **Data Loading**: Automatic on page refresh
- **Person Records**: 5 users successfully loaded
- **Access Levels**: 1 access level loaded

### Troubleshooting (Historical Issues - Now Resolved)

#### 1. "Authentication required" Error âœ… RESOLVED
- **Previous Issue**: Invalid or missing access token
- **Solution Applied**: Correct token configured in environment
- **Status**: Working correctly

#### 2. "API access abnormal" Error âœ… RESOLVED
- **Previous Issue**: API client not properly configured
- **Solution Applied**: "Browse API" enabled in admin panel
- **Status**: API access fully functional

#### 3. SSL Certificate Errors âœ… RESOLVED
- **Previous Issue**: Self-signed certificate blocking requests
- **Solution Applied**: Next.js proxy with axios HTTPS agent bypass
- **Status**: SSL certificate issues handled automatically

#### 4. CORS Issues âœ… RESOLVED
- **Previous Issue**: Browser blocking cross-origin requests
- **Solution Applied**: Server-side API proxy routes
- **Status**: All CORS restrictions bypassed

#### 5. Data Not Loading âœ… RESOLVED
- **Previous Issue**: API calls failing silently
- **Solution Applied**: Comprehensive error handling and logging
- **Status**: Data loads successfully on every page refresh

### Debug Steps

1. **Verify Admin Panel Access**:
   - Can you log into ZKBio admin panel?
   - Can you access API Authorization page?

2. **Check API Client Configuration**:
   - Is Client ID unique?
   - Was Client Secret saved correctly?
   - Did you click "Browse API"?

3. **Test Direct API Calls**:
   - Use curl commands above to test connectivity
   - Check response codes and messages

4. **Verify Environment Variables**:
   - Is `.env.local` in project root?
   - Do variables match admin panel values?

## API Management

### Refresh API Authorization Page
- Click **Refresh** at the upper part of the API authorization list
- This gets the most updated version of the page

### Edit API Client
- Click the **Edit** icon to modify client details
- Update Client ID or regenerate Client Secret if needed

### Delete API Client
- Select the client and click **Delete**
- Confirm deletion when prompted

## Security Best Practices

1. **Store Tokens Securely**: Never commit API tokens to version control
2. **Use HTTPS**: Always use HTTPS in production
3. **IP Whitelisting**: Consider restricting API access to specific IP addresses
4. **Token Rotation**: Regularly rotate API tokens for security
5. **Monitor Usage**: Monitor API usage in ZKBio admin panel

## Support

For additional support:
- Refer to ZKBio CVSecurity User Manual (API section)
- Contact ZKTECO technical support
- Check ZKBio server logs for detailed error information