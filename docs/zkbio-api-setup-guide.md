# ZKBio CVSecurity API Setup Guide

## Overview

This guide provides detailed instructions for setting up and configuring the ZKBio CVSecurity API integration for your Banking Access Control System.

## Prerequisites

- ZKBio CVSecurity server (version 6.0.0 or above)
- Superuser access to ZKBio admin panel
- Network access to ZKBio server from your application

## API Authorization Setup

### Step 1: Access ZKBio Admin Panel

1. Open your web browser and navigate to your ZKBio CVSecurity server:
   ```
   https://your-server-ip:8098
   ```

2. Log in with superuser credentials:
   - **Username**: `admin` (or your superuser account)
   - **Password**: `#eCOM@786SEC` (or your configured password)

### Step 2: Navigate to API Authorization

1. In the admin panel, go to:
   ```
   System → Authority Management → API Authorization
   ```

2. You should see the API Authorization management page.

### Step 3: Create New API Client

1. Click the **New** button at the upper part of the list.

2. Configure the API client:
   - **Client ID**: Enter a unique identifier (e.g., `banking-system-api`)
   - **Client Secret**: This will be auto-generated by the system

3. **Important**: Save the generated **Client Secret** - this is your API token!

### Step 4: Enable API Access

1. After creating the client, click **Browse API** on the API Authorization page.

2. This opens the API operation page - keep this page open for normal API access.

3. **Note**: If client ID and secret are not properly configured, API access will be abnormal.

### Step 5: Configure Application Environment

Create or update your `.env.local` file with the API credentials:

```bash
NEXT_PUBLIC_ZKBIO_API_URL=https://your-server-ip:8098/api
NEXT_PUBLIC_ZKBIO_API_TOKEN=your_client_secret_here
```

Replace `your_client_secret_here` with the Client Secret generated in Step 3.

## API Authentication Method

### URL Parameter Authentication

ZKBio CVSecurity requires access tokens to be passed as URL parameters, not in headers:

```bash
# Correct format
GET /api/v2/person/list?pageNo=1&pageSize=10&access_token=YOUR_CLIENT_SECRET

# Incorrect format (will not work)
GET /api/v2/person/list?pageNo=1&pageSize=10
Authorization: Bearer YOUR_CLIENT_SECRET
```

### Example API Calls

```bash
# Get access levels
curl -k "https://192.168.0.93:8098/api/v2/accLevel/list?pageNo=1&pageSize=10&access_token=8D1E99707293387C5B3BFC7291AD38CB"

# Get persons
curl -k "https://192.168.0.93:8098/api/v2/person/getPersonList?pageNo=1&pageSize=10&access_token=8D1E99707293387C5B3BFC7291AD38CB"

# Get readers
curl -k "https://192.168.0.93:8098/api/v2/reader/list?pageNo=1&pageSize=10&access_token=8D1E99707293387C5B3BFC7291AD38CB"
```

## API Response Format

All ZKBio API responses follow this structure:

```json
{
  "code": 0,
  "message": "success",
  "data": {
    // Actual response data
  }
}
```

### Response Codes

- `code: 0` = Success
- `code: 400` = Bad Request
- `code: 401` = Unauthorized (check access token)
- `code: 403` = Forbidden
- `code: 404` = Not Found

## Testing API Connection

### 1. Test Access Levels API

```bash
curl -k "https://your-server:8098/api/v2/accLevel/list?pageNo=1&pageSize=5&access_token=YOUR_TOKEN" | jq .
```

Expected response:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "page": 0,
    "size": 5,
    "total": 1,
    "data": [
      {
        "id": "access_level_id",
        "name": "General"
      }
    ],
    "offset": 0,
    "lastPage": true
  }
}
```

### 2. Test Person API

```bash
curl -k "https://your-server:8098/api/v2/person/getPersonList?pageNo=1&pageSize=5&access_token=YOUR_TOKEN" | jq .
```

### 3. Test Reader API

```bash
curl -k "https://your-server:8098/api/v2/reader/list?pageNo=1&pageSize=5&access_token=YOUR_TOKEN" | jq .
```

## Troubleshooting

### Common Issues

#### 1. "Authentication required" Error
- **Cause**: Invalid or missing access token
- **Solution**: Verify Client Secret in `.env.local` matches admin panel

#### 2. "API access abnormal" Error
- **Cause**: API client not properly configured
- **Solution**: Ensure "Browse API" was clicked in admin panel

#### 3. SSL Certificate Errors
- **Cause**: Self-signed certificate
- **Solution**: Add certificate to trust store or use `curl -k` for testing

#### 4. Network Connectivity Issues
- **Cause**: Firewall blocking API access
- **Solution**: Ensure port 8098 is accessible from application server

### Debug Steps

1. **Verify Admin Panel Access**:
   - Can you log into ZKBio admin panel?
   - Can you access API Authorization page?

2. **Check API Client Configuration**:
   - Is Client ID unique?
   - Was Client Secret saved correctly?
   - Did you click "Browse API"?

3. **Test Direct API Calls**:
   - Use curl commands above to test connectivity
   - Check response codes and messages

4. **Verify Environment Variables**:
   - Is `.env.local` in project root?
   - Do variables match admin panel values?

## API Management

### Refresh API Authorization Page
- Click **Refresh** at the upper part of the API authorization list
- This gets the most updated version of the page

### Edit API Client
- Click the **Edit** icon to modify client details
- Update Client ID or regenerate Client Secret if needed

### Delete API Client
- Select the client and click **Delete**
- Confirm deletion when prompted

## Security Best Practices

1. **Store Tokens Securely**: Never commit API tokens to version control
2. **Use HTTPS**: Always use HTTPS in production
3. **IP Whitelisting**: Consider restricting API access to specific IP addresses
4. **Token Rotation**: Regularly rotate API tokens for security
5. **Monitor Usage**: Monitor API usage in ZKBio admin panel

## Support

For additional support:
- Refer to ZKBio CVSecurity User Manual (API section)
- Contact ZKTECO technical support
- Check ZKBio server logs for detailed error information